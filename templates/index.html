{% extends 'layout.html' %}

{% block content %}
<!-- ─────────────── Portfolio Input Section ─────────────── -->
<section class="section">
    <h2 class="section-title">Portfolio Setup</h2>
    <div class="error-message" id="error-message"></div>

    <form id="analysis-form">
        <!-- Date range + benchmark ----------------------------------------->
        <div class="form-group" style="display:flex;gap:20px;">
            <div style="flex:1;">
                <label for="start-date">Start Date</label>
                <input type="date" id="start-date" name="start-date" required>
            </div>
            <div style="flex:1;">
                <label for="end-date">End Date</label>
                <input type="date" id="end-date" name="end-date" required>
            </div>
            <div style="flex:1;">
                <label for="benchmark-select">Benchmark</label>
                <div id="benchmark-container">
                    <select id="benchmark-select" name="benchmark-select" class="form-control">
                        <option value="SPY" selected>SPY (S&amp;P 500)</option>
                        <option value="AOA">AOA (iShares Agg. Allocation)</option>
                        <option value="AOR">AOR (iShares Growth Allocation)</option>
                        <option value="AOM">AOM (iShares Moderate Allocation)</option>
                        <option value="AOK">AOK (iShares Conservative Allocation)</option>
                        <option value="VT">VT (Vanguard Total World)</option>
                        <option value="VXUS">VXUS (Vanguard ex‑US)</option>
                        <option value="custom">Custom Ticker…</option>
                    </select>

                    <!-- custom benchmark autocomplete -->
                    <div class="autocomplete-container">
                        <input type="text" id="custom-benchmark"
                               placeholder="Enter ticker symbol"
                               style="display:none;margin-top:5px;">
                        <div id="ticker-suggestions" class="suggestions-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tickers + weights ---------------------------------------------->
        <div class="form-group">
            <label>Portfolio Securities</label>

            <div id="ticker-inputs" class="ticker-inputs">
                <!-- rows are injected by JS -->
            </div>

            <!-- controls under ticker rows -->
            <div class="weight-controls-row">
                <button type="button" id="btn-equal-weights"
                        class="btn btn-outline sm-btn">Equal Weights</button>

                <!-- full‑width pill shows running sum -->
                <div id="weight-sum" class="weight-pill">Total: 0%</div>
            </div>

            <!-- add‑ticker on its own line -->
            <button type="button" id="add-ticker"
                    class="btn btn-secondary add-ticker-btn">Add Ticker</button>
        </div>

        <!-- run analysis -->
        <div class="form-group" style="margin-top:20px;">
            <button type="submit" id="analyze-btn" class="btn btn-primary">
                Analyze Portfolio
            </button>
        </div>
    </form>

    <!-- loader -->
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p>Retrieving data and analyzing portfolio…</p>
    </div>
</section>

<!-- ─────────────── Results Section ─────────────── -->
<section id="results-container" class="section results-container">
    <h2 class="section-title">Portfolio Analysis Results</h2>

    <!-- metrics table (unchanged) -->
    <div class="metrics-table">
        {% comment %} … existing table markup left intact … {% endcomment %}
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
            <!-- header -->
            <thead>
                <tr>
                    <th style="text-align:left;padding:10px;border-bottom:2px solid #DFE1E6;">Metric</th>
                    <th style="text-align:right;padding:10px;border-bottom:2px solid #DFE1E6;">Portfolio</th>
                    <th style="text-align:right;padding:10px;border-bottom:2px solid #DFE1E6;"
                        id="benchmark-header">Benchmark (SPY)</th>
                </tr>
            </thead>
            <tbody>
                <!-- rows (same as before) -->
                <tr><td>CAGR</td><td id="cagr-value" class="value-cell"></td><td id="benchmark-cagr-value" class="value-cell"></td></tr>
                <tr><td>Volatility</td><td id="volatility-value" class="value-cell"></td><td id="benchmark-volatility-value" class="value-cell"></td></tr>
                <tr><td>Sharpe Ratio</td><td id="sharpe-value" class="value-cell"></td><td id="benchmark-sharpe-value" class="value-cell"></td></tr>
                <tr><td>Max Drawdown</td><td id="max-drawdown-value" class="value-cell"></td><td id="benchmark-max-drawdown-value" class="value-cell"></td></tr>
                <tr><td>Max Drawdown Duration</td><td id="max-drawdown-duration-value" class="value-cell"></td><td id="benchmark-max-drawdown-duration-value" class="value-cell"></td></tr>
                <tr><td>Sortino Ratio</td><td id="sortino-ratio-value" class="value-cell"></td><td id="benchmark-sortino-ratio-value" class="value-cell"></td></tr>
                <tr><td>Calmar Ratio</td><td id="calmar-ratio-value" class="value-cell"></td><td id="benchmark-calmar-ratio-value" class="value-cell"></td></tr>
                <tr><td>Total Return</td><td id="total-return-value" class="value-cell"></td><td id="benchmark-total-return-value" class="value-cell"></td></tr>
                <tr><td>Rolling 12M Return</td><td id="rolling-return-value" class="value-cell"></td><td id="benchmark-rolling-return-value" class="value-cell"></td></tr>
                <tr><td>Rolling 12M Volatility</td><td id="rolling-volatility-value" class="value-cell"></td><td id="benchmark-rolling-volatility-value" class="value-cell"></td></tr>
                <tr><td>Best Month</td><td id="best-month-value" class="value-cell"></td><td id="benchmark-best-month-value" class="value-cell"></td></tr>
                <tr><td>Worst Month</td><td id="worst-month-value" class="value-cell"></td><td id="benchmark-worst-month-value" class="value-cell"></td></tr>
                <tr><td>Time Period</td><td id="period-value" class="value-cell" colspan="2"></td></tr>
            </tbody>
        </table>
    </div>

    <!-- benchmark‑notice (unchanged) -->
    <div id="benchmark-in-portfolio-notice"
         style="display:none;background:#E6EFFC;padding:10px 15px;border-radius:4px;margin-bottom:20px;">
        <strong>Note:</strong>
        The benchmark (<span id="benchmark-name-notice">SPY</span>) is included in your portfolio.
        Separate metrics are shown based on the benchmark's performance alone.
    </div>

    <!-- download button -->
    <div style="margin:20px 0;">
        <button id="download-returns-btn" class="btn btn-success" disabled>
            Download Returns Data (CSV)
        </button>
    </div>

    <!-- chart tabs (unchanged labels) -->
    <div class="tabs">
        <div class="tab active" data-tab="summary-tab">Summary</div>
        <div class="tab" data-tab="allocation-tab">Allocation</div>
        <div class="tab" data-tab="equity-curve-tab">Equity Curve</div>
        <div class="tab" data-tab="drawdown-tab">Drawdown</div>
        <div class="tab" data-tab="returns-tab" id="returns-tab-label">Annual Returns</div>
        <div class="tab" data-tab="correlation-tab">Correlation</div>
    </div>

    <!-- tab panes ----------------------------------------------------------->
    <div id="summary-tab"    class="tab-content active"><div class="summary-container"><h3>Portfolio Summary</h3><p>This tab provides an overview of your portfolio performance. Check other tabs for detailed analysis.</p><div id="summary-metrics" class="metrics-summary"></div></div></div>
    <div id="allocation-tab" class="tab-content"><div id="allocation-chart" class="chart-container"></div><div class="allocation-legend" id="allocation-legend"></div></div>
    <div id="equity-curve-tab" class="tab-content"><div id="equity-chart" class="chart-container"></div></div>
    <div id="drawdown-tab" class="tab-content"><div id="drawdown-chart" class="chart-container"></div></div>
    <div id="returns-tab" class="tab-content"><div id="returns-chart" class="chart-container"></div></div>

    <!-- correlation gets a wrapper for sizing -->
    <div id="correlation-tab" class="tab-content">
        <div id="correlation-chart" class="chart-container correlation-wrapper"></div>
    </div>
</section>
{% endblock %}
